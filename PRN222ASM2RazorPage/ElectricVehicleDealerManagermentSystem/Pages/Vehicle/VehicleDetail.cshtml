@page
@model ElectricVehicleDealerManagermentSystem.Pages.Vehicle.VehicleDetailModel

@{
    ViewData["Title"] = Model.Vehicle?.Model ?? "Vehicle Detail";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/css/CarDetail.css" asp-append-version="true" rel="stylesheet">
}

<div class="container-fluid py-4">
    <!-- Back Button -->
    <div class="row mb-3">
        <div class="col-12">
            <a asp-page="/Vehicle/Browse" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Browse
            </a>
        </div>
    </div>

    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> @Model.ErrorMessage
        </div>
    }

    @if (Model.Vehicle != null)
    {
        <!-- Main Content: Car Info, Image, Map and Specs (Left) + Dashboard (Right) -->
        <div class="row mb-4">
            <!-- Left: Car Info, Image, Map and Specs Combined -->
            <div class="col-lg-9 mb-4 mb-lg-0">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <!-- Car Title -->
                        <div class="mb-4">
                            <h2 class="car-title mb-1">@Model.Vehicle.Model</h2>
                            <p class="car-id mb-0">@Model.Vehicle.Id.ToString().PadLeft(12, '0')</p>
                        </div>

                        <div class="row mb-4">
                            <!-- Left: Status Indicators -->
                            <div class="col-lg-5 col-md-6">
                                <!-- Price -->
                                <div class="status-box mb-3">
                                    <div class="status-icon-box">
                                        <i class="bi bi-currency-dollar"></i>
                                    </div>
                                    <div class="status-details">
                                        <span class="status-label-top">Price</span>
                                        <div class="status-progress-wrapper">
                                            <div class="progress" style="height: 4px">
                                                <div class="progress-bar bg-success" style="width: 100%"></div>
                                            </div>
                                            <span class="status-percent text-success">@Model.Vehicle.Price.ToString("C")</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Category -->
                                <div class="status-box mb-3">
                                    <div class="status-icon-box">
                                        <i class="bi bi-tag"></i>
                                    </div>
                                    <div class="status-details">
                                        <span class="status-label-top">Category</span>
                                        <div class="status-progress-wrapper">
                                            <div class="progress" style="height: 4px">
                                                <div class="progress-bar bg-primary" style="width: 100%"></div>
                                            </div>
                                            <span class="status-percent text-primary">@Model.Vehicle.CategoryName</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Year -->
                                <div class="status-box">
                                    <div class="status-icon-box">
                                        <i class="bi bi-calendar"></i>
                                    </div>
                                    <div class="status-details">
                                        <span class="status-label-top">Year</span>
                                        <div class="status-progress-wrapper">
                                            <div class="progress" style="height: 4px">
                                                <div class="progress-bar bg-info" style="width: 100%"></div>
                                            </div>
                                            <span class="status-percent">@Model.Vehicle.ManufactureDate.Year</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Car Image -->
                            <div class="col-lg-7 col-md-6">
                                <div class="car-image-container-top">
                                    <img src="@(string.IsNullOrEmpty(Model.Vehicle.Image) ? "https://images.unsplash.com/photo-1619405399517-d7fce0f13302?w=800" : Model.Vehicle.Image)"
                                         alt="@Model.Vehicle.Model"
                                         class="img-fluid" />
                                </div>
                            </div>
                        </div>

                        <!-- Map and Specs Section -->
                        <div class="row g-0 mt-3">
                            <!-- Map (Left) -->
                            <div class="col-md-5">
                                <div id="map" class="map-container-horizontal"></div>
                            </div>
                            <!-- Specs (Right) -->
                            <div class="col-md-7">
                                <div class="specs-horizontal ">
                                    <div class="row ps-7">
                                        <div class="col-5">
                                            <div class="spec-item-new mb-3">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Body Type:</small>
                                                    <strong class="spec-value-new">@Model.Vehicle.CategoryName</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="spec-item-new mb-3">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Manufacture Date:</small>
                                                    <strong class="spec-value-new">@Model.Vehicle.ManufactureDate.ToString("yyyy/MM/dd")</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <div class="spec-item-new mb-3">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Colour:</small>
                                                    <strong class="spec-value-new">@Model.Vehicle.Color</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <div class="spec-item-new mb-3">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Model:</small>
                                                    <strong class="spec-value-new">@Model.Vehicle.Model</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <div class="spec-item-new mb-3">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Price:</small>
                                                    <strong class="spec-value-new">@Model.Vehicle.Price.ToString("C")</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="spec-item-new mb-3">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Status:</small>
                                                    <strong class="spec-value-new text-success">AVAILABLE</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <div class="spec-item-new">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Vehicle ID:</small>
                                                    <strong class="spec-value-new">@Model.Vehicle.Id</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <div class="spec-item-new">
                                                <i class="bi bi-circle-fill spec-dot"></i>
                                                <div>
                                                    <small class="spec-label-new">Version:</small>
                                                    <strong class="spec-value-new">@(Model.Vehicle.Version ?? "Standard")</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Dashboard -->
            <div class="col-lg-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="dashboard-section">
                            <!-- User Profile -->
                            <div class="text-center mb-3">
                                <img src="https://randomuser.me/api/portraits/men/32.jpg"
                                     alt="User"
                                     class="dashboard-avatar mb-2">
                                <h6 class="dashboard-name mb-1">@Model.GetUserDisplayName()</h6>
                                <div class="dashboard-groups mb-3">
                                    <span class="dashboard-group-label">Group:</span>
                                    <span class="dashboard-group-value">@(Model.UserRole?.ToUpper() ?? "GUEST")</span>
                                    <span class="dashboard-group-label ms-2">User:</span>
                                    <span class="dashboard-group-value">@(Model.CurrentUserId?.ToString() ?? "N/A")</span>
                                </div>
                            </div>

                            <!-- Dashboard Info -->
                            <div class="dashboard-info">
                                <div class="dashboard-info-item mb-2">
                                    <small class="dashboard-info-label">Phone:</small>
                                    <strong class="dashboard-info-value">@(HttpContext.Session.GetString("CustomerPhone") ?? "N/A")</strong>
                                </div>
                                <div class="dashboard-info-item mb-2">
                                    <small class="dashboard-info-label">Make:</small>
                                    <strong class="dashboard-info-value">@Model.Vehicle.Model</strong>
                                </div>
                                <div class="dashboard-info-item mb-2">
                                    <small class="dashboard-info-label">Model:</small>
                                    <strong class="dashboard-info-value">@Model.Vehicle.Model</strong>
                                </div>
                                <div class="dashboard-info-item mb-2">
                                    <small class="dashboard-info-label">Year:</small>
                                    <strong class="dashboard-info-value">@Model.Vehicle.ManufactureDate.Year</strong>
                                </div>
                                <div class="dashboard-info-item mb-2">
                                    <small class="dashboard-info-label">Price:</small>
                                    <strong class="dashboard-info-value">@Model.Vehicle.Price.ToString("C")</strong>
                                </div>
                                <div class="dashboard-info-item mb-3">
                                    <small class="dashboard-info-label">Color:</small>
                                    <strong class="dashboard-info-value">@Model.Vehicle.Color</strong>
                                </div>

                                <!-- Action Buttons -->
                                <div class="dashboard-buttons mt-4">
                                    @if (Model.IsUserLoggedIn)
                                    {
                                        @if (Model.UserRole == "customer")
                                        {
                                            <button class="btn btn-primary w-100 mb-2 dashboard-btn-buy">
                                                <i class="bi bi-cart-check me-2"></i>Buy
                                            </button>
                                            <button class="btn btn-outline-primary w-100 dashboard-btn-appointment">
                                                <i class="bi bi-calendar-check me-2"></i>Appointment
                                            </button>
                                        }

                                        @if (Model.CanEditVehicle())
                                        {
                                            <a asp-page="/Vehicle/Update" asp-route-id="@Model.Vehicle.Id" class="btn btn-success w-100 mb-2">
                                                <i class="fas fa-edit me-2"></i>Edit Vehicle
                                            </a>
                                        }

                                        @if (Model.CanDeleteVehicle())
                                        {
                                            <a asp-page="/Vehicle/Delete" asp-route-id="@Model.Vehicle.Id" class="btn btn-danger w-100 mb-2">
                                                <i class="fas fa-trash me-2"></i>Delete Vehicle
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <a asp-page="/Credential/Login" class="btn btn-primary w-100 mb-2">
                                            <i class="fas fa-sign-in-alt me-2"></i>Login to Buy
                                        </a>
                                        <a asp-page="/Credential/Register" class="btn btn-outline-primary w-100">
                                            <i class="fas fa-user-plus me-2"></i>Register Now
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Activity Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0">Vehicle Analytics</h5>
                        </div>
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Service Reminders and Reminders Combined -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="row">
                            <!-- Vehicle Information -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-subtitle mb-0">Vehicle Details</h6>
                                </div>
                                <div class="reminder-list">
                                    <div class="reminder-entry mb-3">
                                        <div class="reminder-badge">
                                            <i class="bi bi-car-front-fill"></i>
                                        </div>
                                        <div class="reminder-content">
                                            <strong class="reminder-km">@Model.Vehicle.Model</strong>
                                            <small class="reminder-date-text">Model</small>
                                        </div>
                                    </div>
                                    <div class="reminder-entry">
                                        <div class="reminder-badge">
                                            <i class="bi bi-palette-fill"></i>
                                        </div>
                                        <div class="reminder-content">
                                            <strong class="reminder-km">@Model.Vehicle.Color</strong>
                                            <small class="reminder-date-text">Color</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-subtitle mb-0">Pricing Info</h6>
                                </div>
                                <div class="reminder-list">
                                    <div class="reminder-entry mb-3">
                                        <div class="reminder-badge">
                                            <i class="bi bi-currency-dollar"></i>
                                        </div>
                                        <div class="reminder-content">
                                            <strong class="reminder-km">@Model.Vehicle.Price.ToString("C")</strong>
                                            <small class="reminder-date-text">Current Price</small>
                                        </div>
                                    </div>
                                    <div class="reminder-entry mb-3">
                                        <div class="reminder-badge">
                                            <i class="bi bi-calendar-event"></i>
                                        </div>
                                        <div class="reminder-content">
                                            <strong class="reminder-km">@Model.Vehicle.ManufactureDate.ToString("MMM yyyy")</strong>
                                            <small class="reminder-date-text">Manufacture Date</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-car fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">Vehicle Not Found</h4>
            <p class="text-muted">The requested vehicle could not be found.</p>
            <a asp-page="/Vehicle/Browse" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Browse
            </a>
        </div>
    }
</div>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Leaflet JS for Map -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- SignalR client from CDN (v8) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<!-- Custom JS -->
<script src="/js/CarDetail.js"></script>


